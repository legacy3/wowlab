<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WoWLab Simulation Viewer</title>
    <style>
      :root {
        --bg-primary: #1a1a2e;
        --bg-secondary: #16213e;
        --bg-card: #0f3460;
        --text-primary: #eee;
        --text-secondary: #aaa;
        --accent: #e94560;
        --accent-alt: #533483;
        --success: #4ade80;
        --warning: #fbbf24;
        --info: #60a5fa;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: "Segoe UI", system-ui, sans-serif;
        background: var(--bg-primary);
        color: var(--text-primary);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
      }

      header {
        text-align: center;
        margin-bottom: 30px;
      }

      header h1 {
        font-size: 2rem;
        margin-bottom: 8px;
        background: linear-gradient(135deg, var(--accent), var(--accent-alt));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      header p {
        color: var(--text-secondary);
      }

      .drop-zone {
        border: 2px dashed var(--accent);
        border-radius: 12px;
        padding: 40px;
        text-align: center;
        margin-bottom: 30px;
        transition: all 0.3s ease;
        background: var(--bg-secondary);
        cursor: pointer;
      }

      .drop-zone:hover,
      .drop-zone.drag-over {
        background: var(--bg-card);
        border-color: var(--success);
      }

      .drop-zone input {
        display: none;
      }

      .drop-zone p {
        margin-bottom: 10px;
        font-size: 1.1rem;
      }

      .drop-zone small {
        color: var(--text-secondary);
      }

      .paste-area {
        margin-bottom: 30px;
      }

      .paste-area textarea {
        width: 100%;
        height: 120px;
        background: var(--bg-secondary);
        border: 1px solid var(--bg-card);
        border-radius: 8px;
        padding: 12px;
        color: var(--text-primary);
        font-family: "Consolas", "Monaco", monospace;
        font-size: 13px;
        resize: vertical;
      }

      .paste-area textarea:focus {
        outline: none;
        border-color: var(--accent);
      }

      .paste-area button {
        margin-top: 10px;
        background: var(--accent);
        color: white;
        border: none;
        padding: 10px 24px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        transition: background 0.2s;
      }

      .paste-area button:hover {
        background: #d63d55;
      }

      #results {
        display: none;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 16px;
        margin-bottom: 30px;
      }

      .stat-card {
        background: var(--bg-card);
        border-radius: 10px;
        padding: 20px;
        text-align: center;
      }

      .stat-card.primary {
        background: linear-gradient(135deg, var(--accent), var(--accent-alt));
      }

      .stat-card .label {
        color: var(--text-secondary);
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 8px;
      }

      .stat-card.primary .label {
        color: rgba(255, 255, 255, 0.8);
      }

      .stat-card .value {
        font-size: 1.8rem;
        font-weight: bold;
      }

      .stat-card .sub {
        font-size: 0.85rem;
        color: var(--text-secondary);
        margin-top: 4px;
      }

      .stat-card.primary .sub {
        color: rgba(255, 255, 255, 0.7);
      }

      .section {
        background: var(--bg-secondary);
        border-radius: 12px;
        padding: 24px;
        margin-bottom: 24px;
      }

      .section h2 {
        font-size: 1.2rem;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid var(--bg-card);
      }

      .breakdown-table,
      .action-table {
        width: 100%;
        border-collapse: collapse;
      }

      .breakdown-table th,
      .action-table th {
        text-align: left;
        padding: 12px;
        color: var(--text-secondary);
        font-weight: 500;
        font-size: 0.85rem;
        text-transform: uppercase;
        border-bottom: 1px solid var(--bg-card);
        position: sticky;
        top: 0;
        background: var(--bg-secondary);
      }

      .breakdown-table th.right,
      .action-table th.right {
        text-align: right;
      }

      .breakdown-table td,
      .action-table td {
        padding: 10px 12px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        font-size: 0.9rem;
      }

      .breakdown-table td.right,
      .action-table td.right {
        text-align: right;
        font-family: "Consolas", monospace;
      }

      .breakdown-table tr:hover,
      .action-table tr:hover {
        background: rgba(255, 255, 255, 0.03);
      }

      .spell-name {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .spell-icon {
        width: 28px;
        height: 28px;
        border-radius: 4px;
        background: var(--bg-card);
      }

      .spell-id {
        color: var(--text-secondary);
        font-size: 0.8rem;
      }

      .bar-container {
        position: relative;
        height: 24px;
        background: var(--bg-primary);
        border-radius: 4px;
        overflow: hidden;
      }

      .bar {
        height: 100%;
        background: linear-gradient(90deg, var(--accent), var(--accent-alt));
        border-radius: 4px;
        transition: width 0.5s ease;
      }

      .chart-container {
        margin-top: 20px;
      }

      .chart-bar {
        display: flex;
        align-items: center;
        margin-bottom: 12px;
      }

      .chart-bar .name {
        width: 140px;
        font-size: 0.9rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .chart-bar .bar-wrapper {
        flex: 1;
        margin: 0 12px;
      }

      .chart-bar .pct {
        width: 60px;
        text-align: right;
        font-family: "Consolas", monospace;
        font-size: 0.9rem;
      }

      .json-output {
        background: var(--bg-primary);
        border-radius: 8px;
        padding: 16px;
        font-family: "Consolas", monospace;
        font-size: 12px;
        max-height: 300px;
        overflow: auto;
        white-space: pre-wrap;
        word-break: break-all;
      }

      .cli-hint {
        background: var(--bg-primary);
        border-radius: 8px;
        padding: 16px;
        margin-top: 20px;
      }

      .cli-hint code {
        display: block;
        background: var(--bg-card);
        padding: 12px;
        border-radius: 6px;
        font-family: "Consolas", monospace;
        margin-top: 10px;
        color: var(--success);
      }

      /* Action log styling */
      .action-log-container {
        max-height: 600px;
        overflow-y: auto;
      }

      .action-badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 500;
        text-transform: uppercase;
      }

      .action-badge.cast {
        background: var(--accent);
        color: white;
      }
      .action-badge.damage {
        background: #dc2626;
        color: white;
      }
      .action-badge.aura_apply {
        background: var(--success);
        color: #000;
      }
      .action-badge.aura_refresh {
        background: #22c55e;
        color: #000;
      }
      .action-badge.aura_expire {
        background: #6b7280;
        color: white;
      }
      .action-badge.combat_start {
        background: var(--info);
        color: #000;
      }
      .action-badge.combat_end {
        background: var(--warning);
        color: #000;
      }
      .action-badge.resource_gain {
        background: #8b5cf6;
        color: white;
      }

      .time-col {
        font-family: "Consolas", monospace;
        color: var(--text-secondary);
        width: 80px;
      }

      .damage-col {
        color: #f87171;
      }

      .resource-col {
        color: #60a5fa;
      }

      .gcd-col {
        color: var(--text-secondary);
      }

      .extra-col {
        color: var(--warning);
        font-style: italic;
      }

      .mode-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        margin-left: 10px;
      }

      .mode-badge.report {
        background: var(--success);
        color: #000;
      }
      .mode-badge.batch {
        background: var(--info);
        color: #000;
      }

      @media (max-width: 768px) {
        .chart-bar .name {
          width: 100px;
        }
        .breakdown-table {
          font-size: 0.9rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>WoWLab Simulation Viewer</h1>
        <p>Visualize simulation results from the engine</p>
      </header>

      <div class="drop-zone" id="dropZone">
        <p>Drop JSON file here or click to upload</p>
        <small
          >Supports: <code>engine sim -o json</code> or
          <code>engine sim --report</code></small
        >
        <input type="file" id="fileInput" accept=".json" />
      </div>

      <div class="paste-area">
        <textarea
          id="jsonInput"
          placeholder="Or paste JSON output here..."
        ></textarea>
        <button onclick="parseInput()">Load Results</button>
      </div>

      <div id="results">
        <div class="stats-grid" id="statsGrid"></div>

        <div class="section">
          <h2>Damage Distribution</h2>
          <div class="chart-container" id="damageChart"></div>
        </div>

        <div class="section">
          <h2>Spell Breakdown</h2>
          <table class="breakdown-table" id="breakdownTable">
            <thead>
              <tr>
                <th>Spell</th>
                <th class="right">Casts</th>
                <th class="right">Total Damage</th>
                <th class="right">DPS</th>
                <th class="right">% of Total</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="section" id="actionLogSection" style="display: none">
          <h2>
            Action Log <span class="mode-badge report">Detailed Report</span>
          </h2>
          <div class="action-log-container">
            <table class="action-table" id="actionTable">
              <thead>
                <tr>
                  <th>Time</th>
                  <th>Action</th>
                  <th>Spell/Aura</th>
                  <th class="right">Damage</th>
                  <th class="right">Resource</th>
                  <th class="right">GCD</th>
                  <th>Extra</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div class="section">
          <h2>Raw JSON</h2>
          <div class="json-output" id="jsonOutput"></div>
        </div>
      </div>

      <div class="cli-hint">
        <strong>Generate simulation data:</strong>
        <code
          ># Batch statistics (10k iterations) ./target/release/engine sim
          --spec specs/hunter/beast-mastery.toml -o json -i 10000 > results.json
          # Detailed action report (single iteration) ./target/release/engine
          sim --spec specs/hunter/beast-mastery.toml --report >
          report.json</code
        >
      </div>
    </div>

    <script>
      // Known spell names (can be extended)
      const SPELL_NAMES = {
        // Hunter - Beast Mastery
        34026: "Kill Command",
        217200: "Barbed Shot",
        193455: "Cobra Shot",
        2643: "Multi-Shot",
        53351: "Kill Shot",
        19574: "Bestial Wrath",
        359844: "Call of the Wild",
        321530: "Bloodshed",
        272790: "Frenzy",
      };

      const dropZone = document.getElementById("dropZone");
      const fileInput = document.getElementById("fileInput");
      const jsonInput = document.getElementById("jsonInput");

      // Drag and drop handling
      dropZone.addEventListener("click", () => fileInput.click());

      dropZone.addEventListener("dragover", (e) => {
        e.preventDefault();
        dropZone.classList.add("drag-over");
      });

      dropZone.addEventListener("dragleave", () => {
        dropZone.classList.remove("drag-over");
      });

      dropZone.addEventListener("drop", (e) => {
        e.preventDefault();
        dropZone.classList.remove("drag-over");
        const file = e.dataTransfer.files[0];
        if (file) readFile(file);
      });

      fileInput.addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (file) readFile(file);
      });

      function readFile(file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          jsonInput.value = e.target.result;
          parseInput();
        };
        reader.readAsText(file);
      }

      function parseInput() {
        try {
          const data = JSON.parse(jsonInput.value);
          renderResults(data);
        } catch (e) {
          alert("Invalid JSON: " + e.message);
        }
      }

      function formatNumber(n, decimals = 0) {
        if (n === null || n === undefined) return "N/A";
        if (n >= 1000000) {
          return (n / 1000000).toFixed(2) + "M";
        } else if (n >= 1000) {
          return (n / 1000).toFixed(1) + "K";
        }
        return n.toFixed(decimals);
      }

      function getSpellName(spellId, nameFromData) {
        return nameFromData || SPELL_NAMES[spellId] || `Spell ${spellId}`;
      }

      function isReportFormat(data) {
        // Report format has 'actions' array and 'spec' field
        return Array.isArray(data.actions) && data.spec !== undefined;
      }

      function renderResults(data) {
        document.getElementById("results").style.display = "block";
        const isReport = isReportFormat(data);

        // Build name lookup from actions if available
        const nameFromActions = {};
        if (isReport && data.actions) {
          data.actions.forEach((a) => {
            if (a.id && a.name) nameFromActions[a.id] = a.name;
          });
        }

        // Stats grid
        const statsGrid = document.getElementById("statsGrid");

        if (isReport) {
          // Report format - single iteration
          statsGrid.innerHTML = `
                    <div class="stat-card primary">
                        <div class="label">DPS</div>
                        <div class="value">${formatNumber(data.dps, 0)}</div>
                        <div class="sub">${data.spec}</div>
                    </div>
                    <div class="stat-card">
                        <div class="label">Total Damage</div>
                        <div class="value">${formatNumber(data.total_damage, 0)}</div>
                    </div>
                    <div class="stat-card">
                        <div class="label">Duration</div>
                        <div class="value">${data.duration}s</div>
                    </div>
                    <div class="stat-card">
                        <div class="label">Total Casts</div>
                        <div class="value">${data.total_casts}</div>
                    </div>
                    <div class="stat-card">
                        <div class="label">Actions Logged</div>
                        <div class="value">${data.actions ? data.actions.length : 0}</div>
                    </div>
                `;
        } else {
          // Batch format
          const stdDps =
            data.std_dps !== null && data.std_dps !== undefined
              ? data.std_dps.toFixed(1)
              : "N/A";
          const errorPct =
            data.std_dps !== null &&
            data.std_dps !== undefined &&
            data.mean_dps > 0
              ? ((data.std_dps / data.mean_dps) * 100).toFixed(2) + "%"
              : "N/A";

          statsGrid.innerHTML = `
                    <div class="stat-card primary">
                        <div class="label">Mean DPS</div>
                        <div class="value">${formatNumber(data.mean_dps, 0)}</div>
                        <div class="sub">&plusmn; ${stdDps}</div>
                    </div>
                    <div class="stat-card">
                        <div class="label">Min DPS</div>
                        <div class="value">${formatNumber(data.min_dps, 0)}</div>
                    </div>
                    <div class="stat-card">
                        <div class="label">Max DPS</div>
                        <div class="value">${formatNumber(data.max_dps, 0)}</div>
                    </div>
                    <div class="stat-card">
                        <div class="label">Iterations</div>
                        <div class="value">${formatNumber(data.iterations)}</div>
                    </div>
                    <div class="stat-card">
                        <div class="label">Total Casts</div>
                        <div class="value">${formatNumber(data.total_casts)}</div>
                        <div class="sub">${(data.total_casts / data.iterations).toFixed(1)} per sim</div>
                    </div>
                    <div class="stat-card">
                        <div class="label">Error %</div>
                        <div class="value">${errorPct}</div>
                    </div>
                `;
        }

        // Sort breakdown by damage
        const breakdown = [...(data.spell_breakdown || [])].sort(
          (a, b) => b.total_damage - a.total_damage,
        );
        const iterations = isReport ? 1 : data.iterations;

        // Damage chart
        const chartContainer = document.getElementById("damageChart");
        chartContainer.innerHTML = breakdown
          .map((spell) => {
            const name = getSpellName(
              spell.spell_id,
              nameFromActions[spell.spell_id],
            );
            return `
                <div class="chart-bar">
                    <div class="name" title="${name}">${name}</div>
                    <div class="bar-wrapper">
                        <div class="bar-container">
                            <div class="bar" style="width: ${spell.pct_of_total}%"></div>
                        </div>
                    </div>
                    <div class="pct">${spell.pct_of_total.toFixed(1)}%</div>
                </div>
            `;
          })
          .join("");

        // Breakdown table
        const tbody = document.querySelector("#breakdownTable tbody");
        tbody.innerHTML = breakdown
          .map((spell) => {
            const name = getSpellName(
              spell.spell_id,
              nameFromActions[spell.spell_id],
            );
            return `
                <tr>
                    <td>
                        <div class="spell-name">
                            <div>
                                <div>${name}</div>
                                <div class="spell-id">#${spell.spell_id}</div>
                            </div>
                        </div>
                    </td>
                    <td class="right">${formatNumber(spell.casts / iterations, 1)}</td>
                    <td class="right">${formatNumber(spell.total_damage / iterations, 0)}</td>
                    <td class="right">${formatNumber(spell.dps_contribution, 0)}</td>
                    <td class="right">${spell.pct_of_total.toFixed(1)}%</td>
                </tr>
            `;
          })
          .join("");

        // Action log (only for report format)
        const actionLogSection = document.getElementById("actionLogSection");
        if (isReport && data.actions && data.actions.length > 0) {
          actionLogSection.style.display = "block";
          const actionTbody = document.querySelector("#actionTable tbody");
          actionTbody.innerHTML = data.actions
            .map((action) => {
              const actionClass = action.action.replace(/_/g, "_");
              return `
                    <tr>
                        <td class="time-col">${action.time.toFixed(2)}s</td>
                        <td><span class="action-badge ${actionClass}">${action.action.replace(/_/g, " ")}</span></td>
                        <td>${action.name || "-"}</td>
                        <td class="right damage-col">${action.damage ? formatNumber(action.damage, 0) : "-"}</td>
                        <td class="right resource-col">${action.resource !== undefined ? action.resource.toFixed(0) : "-"}</td>
                        <td class="right gcd-col">${action.gcd ? action.gcd.toFixed(2) + "s" : "-"}</td>
                        <td class="extra-col">${action.extra || ""}</td>
                    </tr>
                `;
            })
            .join("");
        } else {
          actionLogSection.style.display = "none";
        }

        // Raw JSON
        document.getElementById("jsonOutput").textContent = JSON.stringify(
          data,
          null,
          2,
        );

        // Scroll to results
        document
          .getElementById("results")
          .scrollIntoView({ behavior: "smooth" });
      }
    </script>
  </body>
</html>
