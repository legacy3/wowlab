---
title: Channels
description: WebSocket channel types, authorization, and message flow
---

# Channels

Centrifugo channels are namespaced paths that control message routing and authorization.

## Channel Overview

```mermaid
flowchart TB
    subgraph Namespaces["Channel Namespaces"]
        subgraph nodes["nodes:*"]
            NodesOnline["nodes:online<br/>Presence"]
            NodesId["nodes:{node-id}<br/>Per-node"]
        end

        subgraph jobs["jobs:*"]
            JobsId["jobs:{job-id}<br/>Per-job"]
        end

        subgraph chunks["chunks:*"]
            ChunksComplete["chunks:complete<br/>Result submission"]
        end
    end

    Node[Compute Node] -->|subscribe| NodesId
    Node -->|auto-join| NodesOnline
    Node -->|publish| ChunksComplete

    Portal[Portal] -->|subscribe| JobsId

    Sentinel[Sentinel] -->|publish| NodesId
    Sentinel[Sentinel] -->|publish| JobsId
```

## Channel Details

### nodes:online

**Purpose:** Presence tracking for online nodes (hint only, not authoritative)

| Property  | Value                         |
| --------- | ----------------------------- |
| Type      | Presence                      |
| Direction | Automatic (join/leave events) |
| Subscribe | All authenticated nodes       |
| Publish   | Nobody (presence only)        |

```mermaid
sequenceDiagram
    participant Node1
    participant Node2
    participant Centrifugo

    Node1->>Centrifugo: Connect
    Centrifugo-->>Node2: Join event: Node1

    Node1->>Centrifugo: Disconnect
    Centrifugo-->>Node2: Leave event: Node1
```

**Important:** Presence is a HINT, not authoritative. Use Redis heartbeat timestamps for health decisions.

### nodes:\{id\}

**Purpose:** Node-specific channel for chunk assignments and config updates

| Property  | Value                        |
| --------- | ---------------------------- |
| Type      | Subscribe                    |
| Direction | Sentinel → Node              |
| Subscribe | Only that specific node      |
| Publish   | Only Sentinel (via HTTP API) |

```mermaid
sequenceDiagram
    participant Sentinel
    participant Centrifugo
    participant Node

    Sentinel->>Centrifugo: POST /api/publish<br/>channel: nodes:node-123
    Centrifugo-->>Node: {type: "chunk", ...}
```

**Messages sent:**

- Chunk assignments
- Config updates
- Heartbeat pings

### jobs:\{id\}

**Purpose:** Job-specific channel for progress updates to portal

| Property  | Value                        |
| --------- | ---------------------------- |
| Type      | Subscribe                    |
| Direction | Sentinel → Portal            |
| Subscribe | Job owner only               |
| Publish   | Only Sentinel (via HTTP API) |

```mermaid
sequenceDiagram
    participant Sentinel
    participant Centrifugo
    participant Portal

    Sentinel->>Centrifugo: POST /api/publish<br/>channel: jobs:job-456
    Centrifugo-->>Portal: {type: "progress", completed: 5, total: 10}
```

**Messages sent:**

- Progress updates
- Job completion with results

### chunks:complete

**Purpose:** Chunk result submission from nodes

| Property  | Value                                  |
| --------- | -------------------------------------- |
| Type      | Publish (proxied)                      |
| Direction | Node → Sentinel                        |
| Subscribe | Nobody                                 |
| Publish   | Assigned node only (verified in proxy) |

```mermaid
sequenceDiagram
    participant Node
    participant Centrifugo
    participant Sentinel
    participant Redis

    Node->>Centrifugo: publish to chunks:complete
    Centrifugo->>Sentinel: POST /proxy/publish
    Sentinel->>Sentinel: Verify node is assigned
    Sentinel->>Redis: EVALSHA complete_chunk
    Redis-->>Sentinel: {OK, job_id, 5, 10}
    Sentinel-->>Centrifugo: {result: {}}
    Centrifugo-->>Node: Publish confirmed
```

## Authorization Matrix

| Channel           | Who Can Subscribe | Who Can Publish    | Enforced By     |
| ----------------- | ----------------- | ------------------ | --------------- |
| `nodes:{id}`      | Only that node    | Only Sentinel      | Subscribe proxy |
| `jobs:{id}`       | Job owner only    | Only Sentinel      | Subscribe proxy |
| `nodes:online`    | All authenticated | Nobody             | Presence only   |
| `chunks:complete` | Nobody            | Assigned node only | Publish proxy   |

## Subscribe Authorization

All subscriptions go through the subscribe proxy:

```mermaid
flowchart TD
    Subscribe[Subscribe Request] --> Parse{Parse Channel}

    Parse -->|nodes:*| NodesCheck{Check User ID<br/>Matches Channel}
    NodesCheck -->|Yes| Allow[Allow]
    NodesCheck -->|No| Deny[Deny]

    Parse -->|jobs:*| JobsCheck{Check User<br/>Owns Job}
    JobsCheck -->|Yes| Allow
    JobsCheck -->|No| Deny

    Parse -->|Unknown| Deny
```

**Subscribe proxy logic:**

```rust
fn authorize_subscribe(user: &str, channel: &str) -> Result<()> {
    if channel.starts_with("nodes:") {
        let node_id = channel.strip_prefix("nodes:").unwrap();
        if node_id == "online" {
            // All authenticated users can join presence
            return Ok(());
        }
        // Node can only subscribe to their own channel
        if node_id != user {
            return Err(AuthError::NotAuthorized);
        }
    } else if channel.starts_with("jobs:") {
        let job_id = channel.strip_prefix("jobs:").unwrap();
        // Verify user owns this job (query Supabase)
        if !user_owns_job(user, job_id).await? {
            return Err(AuthError::NotAuthorized);
        }
    } else {
        return Err(AuthError::UnknownChannel);
    }
    Ok(())
}
```

## History and Recovery

Centrifugo maintains message history for at-least-once delivery:

| Namespace | history_size | history_ttl | force_recovery |
| --------- | ------------ | ----------- | -------------- |
| nodes     | 10           | 60s         | true           |
| jobs      | 100          | 600s        | true           |
| chunks    | -            | -           | -              |

```mermaid
sequenceDiagram
    participant Node
    participant Centrifugo

    Node->>Centrifugo: Connect
    Note over Node: Disconnected for 30s

    Node->>Centrifugo: Reconnect with last offset
    Centrifugo->>Centrifugo: Check history
    Centrifugo-->>Node: Missed messages (if within window)

    Note over Node: If offline > 60s or > 10 messages missed
    Node->>Centrifugo: RPC: getAssignedChunks
    Note over Node: Full resync from Redis
```

**Recovery limits:**

- If offline > history_ttl, must resync
- If missed > history_size, must resync
- Nodes should always call `getAssignedChunks` on connect
