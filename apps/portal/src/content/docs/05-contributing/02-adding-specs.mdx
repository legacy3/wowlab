---
title: Adding Specs
description: Implement a new spec from scratch
nextSteps:
  - 05-contributing/03-adding-data
  - 04-engine/04-type-system
---

# Adding Specs

Implement a new specialization in the engine.

## Create the folder structure

```bash
mkdir -p crates/engine/src/specs/{class}/{spec}
```

Example for Frost Mage:

```bash
mkdir -p crates/engine/src/specs/mage/frost
```

## Create files

Create these files in the spec folder:

```
constants.rs   - Spell/aura IDs
spells.rs      - SpellDef definitions
auras.rs       - AuraDef definitions
talents.rs     - Talent flags
procs.rs       - Proc handlers
handler.rs     - SpecHandler implementation
rotation.rs    - SpecResolver setup
mod.rs         - Module exports
tests.rs       - Unit tests
```

## constants.rs

```rust
use crate::types::{SpellIdx, AuraIdx};

// Spells
pub const FROSTBOLT: SpellIdx = SpellIdx(116);
pub const ICE_LANCE: SpellIdx = SpellIdx(30455);
pub const FLURRY: SpellIdx = SpellIdx(44614);

// Auras
pub const FINGERS_OF_FROST: AuraIdx = AuraIdx(44544);
pub const BRAIN_FREEZE: AuraIdx = AuraIdx(190446);
pub const WINTERS_CHILL: AuraIdx = AuraIdx(228358);
```

## spells.rs

```rust
use super::constants::*;
use crate::spec::{SpellBuilder, SpellDef};
use crate::types::{DamageSchool, ResourceType};

pub fn spell_definitions() -> Vec<SpellDef> {
    vec![
        SpellBuilder::new(FROSTBOLT, "Frostbolt")
            .school(DamageSchool::Frost)
            .cast_time(2.0)
            .cost(ResourceType::Mana, 0.02)  // 2% base mana
            .magic_damage(1.2)
            .build(),

        SpellBuilder::new(ICE_LANCE, "Ice Lance")
            .school(DamageSchool::Frost)
            .instant()
            .cost(ResourceType::Mana, 0.01)
            .magic_damage(0.3)
            .build(),
    ]
}
```

## auras.rs

```rust
use super::constants::*;
use crate::spec::{AuraBuilder, AuraDef};

pub fn aura_definitions() -> Vec<AuraDef> {
    vec![
        AuraBuilder::buff(FINGERS_OF_FROST, "Fingers of Frost", 15.0)
            .max_stacks(2)
            .build(),

        AuraBuilder::buff(BRAIN_FREEZE, "Brain Freeze", 15.0)
            .build(),

        AuraBuilder::debuff(WINTERS_CHILL, "Winter's Chill", 6.0)
            .max_stacks(2)
            .build(),
    ]
}
```

## talents.rs

```rust
use bitflags::bitflags;

bitflags! {
    pub struct TalentFlags: u64 {
        const LONELY_WINTER = 1 << 0;
        const BONE_CHILLING = 1 << 1;
        const ICE_NOVA = 1 << 2;
        // Add all talents...
    }
}
```

## procs.rs

```rust
use super::constants::*;
use crate::proc::{FixedProc, ProcEffect, ProcFlags, ProcHandler, ProcRegistry, RppmProc};

pub fn setup_procs(registry: &mut ProcRegistry) {
    // Fingers of Frost: 15% on Frostbolt
    registry.register_fixed(
        FixedProc::new(FINGERS_OF_FROST_PROC, 0.15),
        ProcHandler::new(
            FINGERS_OF_FROST_PROC,
            "Fingers of Frost",
            ProcFlags::ON_CAST,
            ProcEffect::ApplyAura {
                aura: FINGERS_OF_FROST,
            },
        ),
    );
}
```

## handler.rs

```rust
use super::{auras, constants::*, procs, spells, talents::TalentFlags};
use crate::handler::SpecHandler;
use crate::rotation::CompiledRotation;
use crate::sim::SimState;
use crate::types::*;

pub struct FrostMageHandler {
    talents: TalentFlags,
    rotation: CompiledRotation,
}

impl SpecHandler for FrostMageHandler {
    fn spec_id(&self) -> SpecId {
        SpecId::FROST_MAGE
    }

    fn class_id(&self) -> ClassId {
        ClassId::MAGE
    }

    fn display_name(&self) -> &'static str {
        "Frost Mage"
    }

    fn spell_definitions(&self) -> &'static [SpellDef] {
        // Return static slice
    }

    fn init(&self, state: &mut SimState) {
        // Initialize procs, schedule initial events
    }

    fn on_gcd(&self, state: &mut SimState) {
        let action = self.rotation.evaluate(state);
        // Execute action
    }

    // Implement other trait methods...
}
```

## rotation.rs

```rust
use super::constants::*;
use super::talents::TalentFlags;
use crate::rotation::SpecResolver;

pub fn spec_resolver(talents: TalentFlags) -> SpecResolver {
    SpecResolver::new("frost_mage")
        .resource("mana")
        .spell("frostbolt", FROSTBOLT.0)
        .spell("ice_lance", ICE_LANCE.0)
        .spell("flurry", FLURRY.0)
        .aura("fingers_of_frost", FINGERS_OF_FROST.0)
        .aura("brain_freeze", BRAIN_FREEZE.0)
        .talent("lonely_winter", talents.contains(TalentFlags::LONELY_WINTER))
}
```

## Register the spec

In `crates/engine/src/handler/registry.rs`, add the handler:

```rust
pub fn get_handler(spec_id: SpecId) -> Option<Box<dyn SpecHandler>> {
    match spec_id {
        SpecId::FROST_MAGE => Some(Box::new(FrostMageHandler::new())),
        // ...
    }
}
```

## Test

```rust
#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_frostbolt_damage() {
        let handler = FrostMageHandler::new();
        let mut state = setup_test_state();

        handler.cast_spell(&mut state, FROSTBOLT, TargetIdx(0));

        assert!(state.total_damage > 0.0);
    }
}
```
