---
title: Node Registration
description: Complete flow for node registration and WebSocket connection
---

# Node Registration

This document covers the complete flow from node registration to active WebSocket connection.

## Overview

```mermaid
flowchart TD
    subgraph Phase1["Phase 1: Registration"]
        A1[Generate Ed25519 keypair]
        A2[POST /nodes/register]
        A3[Receive node ID + claim code]
    end

    subgraph Phase2["Phase 2: Token Acquisition"]
        B1[POST /nodes/token]
        B2[Receive Centrifugo JWT]
    end

    subgraph Phase3["Phase 3: WebSocket Connection"]
        C1[Connect to beacon.wowlab.gg]
        C2[JWT verification]
        C3[Connect proxy callback]
        C4[Auto-subscribe to nodes:{id}]
        C5[Resync assigned chunks]
    end

    A1 --> A2 --> A3
    A3 --> B1 --> B2
    B2 --> C1 --> C2 --> C3 --> C4 --> C5
```

## Phase 1: Registration

### Generate Keypair

Node generates an Ed25519 keypair on first run:

```mermaid
flowchart LR
    Random[Cryptographic RNG] --> Generate[Ed25519 Keygen]
    Generate --> Private[Private Key<br/>Store securely]
    Generate --> Public[Public Key<br/>Send to server]
```

### Registration Request

```mermaid
sequenceDiagram
    participant Node
    participant Sentinel
    participant Supabase

    Node->>Node: Generate Ed25519 keypair
    Node->>Node: Build signature message:<br/>POST|/nodes/register|timestamp|nonce|body_hash
    Node->>Node: Sign message with private key

    Node->>Sentinel: POST /nodes/register
    Note over Node,Sentinel: Headers: X-Signature, X-Timestamp,<br/>X-Nonce, X-Public-Key<br/>Body: {pubkey, name}

    Sentinel->>Sentinel: Verify signature
    Sentinel->>Sentinel: Check timestamp window (Â±60s)
    Sentinel->>Sentinel: Check nonce not reused

    Sentinel->>Supabase: INSERT INTO nodes
    Supabase-->>Sentinel: node_id

    Sentinel->>Sentinel: Generate claim code

    Sentinel-->>Node: {id, claimCode}
```

### Claim Code

The claim code allows users to associate a node with their account:

```
XXXX-XXXX
```

User enters this code in the portal to claim ownership.

## Phase 2: Token Acquisition

### Request JWT

```mermaid
sequenceDiagram
    participant Node
    participant Sentinel
    participant Supabase

    Node->>Node: Build signature message:<br/>POST|/nodes/token|timestamp|nonce|
    Node->>Node: Sign message

    Node->>Sentinel: POST /nodes/token
    Note over Node,Sentinel: Headers: X-Signature, X-Timestamp,<br/>X-Nonce, X-Public-Key

    Sentinel->>Sentinel: Verify signature
    Sentinel->>Supabase: SELECT node WHERE pubkey_hash = ...
    Supabase-->>Sentinel: Node data

    alt Node not found
        Sentinel-->>Node: 404 Not Found
    else Node exists
        Sentinel->>Sentinel: Create JWT
        Note over Sentinel: sub: node-id<br/>exp: 15 minutes<br/>channels: [nodes:{id}]
        Sentinel-->>Node: {jwt, expiresAt}
    end
```

### JWT Structure

```json
{
  "sub": "node-uuid",
  "exp": 1234567890,
  "iat": 1234567800,
  "nbf": 1234567800,
  "jti": "unique-token-id",
  "channels": ["nodes:node-uuid"],
  "info": {
    "type": "node",
    "pubkey_hash": "sha256-of-pubkey"
  }
}
```

**Important:** The `channels` claim enables auto-subscription on connect.

## Phase 3: WebSocket Connection

### Connection Establishment

```mermaid
sequenceDiagram
    participant Node
    participant Centrifugo
    participant Sentinel
    participant Redis

    Node->>Centrifugo: WSS connect<br/>wss://beacon.wowlab.gg/connection/websocket
    Note over Node,Centrifugo: JWT in connection request

    Centrifugo->>Centrifugo: Verify JWT signature
    Centrifugo->>Centrifugo: Check exp, nbf, iat

    Centrifugo->>Sentinel: POST /proxy/connect
    Note over Centrifugo,Sentinel: {client, user: node-uuid, ...}

    Sentinel->>Sentinel: Verify proxy secret
    Sentinel->>Redis: EVALSHA heartbeat
    Redis-->>Sentinel: {backlog, OK}

    Sentinel-->>Centrifugo: {result: {user, expire_at, meta}}
    Note over Sentinel,Centrifugo: meta includes pubkey_hash

    Centrifugo-->>Node: Connected

    Note over Centrifugo: Auto-subscribe to channels from JWT

    Centrifugo->>Sentinel: POST /proxy/subscribe
    Note over Centrifugo,Sentinel: channel: nodes:node-uuid
    Sentinel-->>Centrifugo: {result: {}}

    Centrifugo-->>Node: Subscribed to nodes:{id}
```

### Resync on Connect

After connection, node should resync to recover any missed assignments:

```mermaid
sequenceDiagram
    participant Node
    participant Centrifugo
    participant Sentinel
    participant Redis

    Node->>Centrifugo: RPC: getAssignedChunks
    Centrifugo->>Sentinel: POST /proxy/rpc
    Note over Centrifugo,Sentinel: method: getAssignedChunks

    Sentinel->>Redis: SMEMBERS {node}:{id}:chunks
    Redis-->>Sentinel: [chunk-1, chunk-2, ...]

    loop For each chunk
        Sentinel->>Redis: HGETALL {chunk}:{chunk_id}
        Redis-->>Sentinel: Chunk data
    end

    Sentinel-->>Centrifugo: {result: {data: {chunks: [...]}}}
    Centrifugo-->>Node: Chunk assignments

    Node->>Node: Process any pending chunks
```

## Complete Flow Diagram

```mermaid
sequenceDiagram
    participant Node
    participant Sentinel
    participant Supabase
    participant Centrifugo
    participant Redis

    rect rgb(240, 248, 255)
        Note over Node,Supabase: Phase 1: Registration
        Node->>Sentinel: POST /register + signature
        Sentinel->>Supabase: INSERT node
        Supabase-->>Sentinel: node_id
        Sentinel-->>Node: {id, claimCode}
    end

    rect rgb(255, 248, 240)
        Note over Node,Sentinel: Phase 2: Token
        Node->>Sentinel: POST /token + signature
        Sentinel->>Supabase: Verify node exists
        Sentinel-->>Node: {jwt}
    end

    rect rgb(240, 255, 240)
        Note over Node,Redis: Phase 3: Connection
        Node->>Centrifugo: WSS connect (JWT)
        Centrifugo->>Sentinel: /proxy/connect
        Sentinel->>Redis: heartbeat
        Sentinel-->>Centrifugo: {meta}
        Centrifugo-->>Node: Connected

        Centrifugo->>Sentinel: /proxy/subscribe
        Sentinel-->>Centrifugo: OK
        Centrifugo-->>Node: Subscribed

        Node->>Centrifugo: RPC: getAssignedChunks
        Centrifugo->>Sentinel: /proxy/rpc
        Sentinel->>Redis: Get chunks
        Sentinel-->>Centrifugo: {chunks}
        Centrifugo-->>Node: Ready to process
    end
```

## Error Handling

| Phase        | Error               | Recovery                      |
| ------------ | ------------------- | ----------------------------- |
| Registration | Invalid signature   | Check key generation          |
| Registration | 409 Conflict        | Public key already registered |
| Token        | 404 Not Found       | Re-register node              |
| Token        | 401 Unauthorized    | Check signature               |
| Connect      | JWT expired         | Request new token             |
| Connect      | Connect proxy error | Retry with backoff            |
| Subscribe    | 403 Forbidden       | Node ID mismatch in JWT       |
